
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Finite State Machines &#8212; Learn TLA+</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/custom.css" />
    <link rel="stylesheet" type="text/css" href="../_static/graphviz.css" />
    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="../_static/js/theme.js"></script>
    <script src="../_static/js/petite-vue.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Operators" href="../examples/index.html" />
    <link rel="prev" title="Modelling Message Queues" href="message-queues.html" /> 
  </head><body data-dark_mode_code_blocks="true">

<div id="top_nav">
    

    <nav>
        
            
        

        <p id="toggle_sidebar">
            <a href="#" title="Toggle sidebar">|||</a>
        </p>
        <h1><a href="../index.html" title="Go to homepage">Learn TLA+</a></h1>

        <a id="mode_toggle" href="#" @click.prevent="handleClick" :title="mode">
    <template v-if="mode == 'light'">
        <svg width="100%" height="100%" viewBox="0 0 79 80" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" xml:space="preserve" style="fill-rule:evenodd;clip-rule:evenodd;stroke-linejoin:round;stroke-miterlimit:2;"><g id="mode_light"><rect id="Bounds" x="0" y="-0" width="78.623" height="79.049" style="fill:none;"/><circle cx="39.311" cy="39.524" r="15.734" style="fill:#fff;"/><g id="beams"><g id="beam"><path id="beam1" serif:id="beam" d="M44.212,4.901c0,-2.705 -2.196,-4.901 -4.901,-4.901c-2.704,-0 -4.9,2.196 -4.9,4.901l-0,9.614c-0,2.705 2.196,4.901 4.9,4.901c2.705,0 4.901,-2.196 4.901,-4.901l0,-9.614Z" style="fill:#fff;"/></g><g id="beam2" serif:id="beam"><path id="beam3" serif:id="beam" d="M67.48,18.073c1.913,-1.912 1.913,-5.018 0,-6.931c-1.912,-1.912 -5.018,-1.912 -6.931,0l-6.798,6.799c-1.912,1.912 -1.912,5.018 0,6.931c1.913,1.912 5.018,1.912 6.931,-0l6.798,-6.799Z" style="fill:#fff;"/></g><g id="beam4" serif:id="beam"><path id="beam5" serif:id="beam" d="M25.728,61.108c1.912,-1.913 1.912,-5.018 -0,-6.931c-1.913,-1.913 -5.019,-1.913 -6.931,-0l-6.799,6.798c-1.912,1.913 -1.912,5.019 0,6.931c1.913,1.913 5.019,1.913 6.931,0l6.799,-6.798Z" style="fill:#fff;"/></g><g id="beam6" serif:id="beam"><path id="beam7" serif:id="beam" d="M60.682,54.177c-1.913,-1.913 -5.018,-1.913 -6.931,-0c-1.912,1.913 -1.912,5.018 0,6.931l6.798,6.798c1.913,1.913 5.019,1.913 6.931,0c1.913,-1.912 1.913,-5.018 0,-6.931l-6.798,-6.798Z" style="fill:#fff;"/></g><g id="beam8" serif:id="beam"><path id="beam9" serif:id="beam" d="M4.901,34.623c-2.705,0 -4.901,2.196 -4.901,4.901c0,2.705 2.196,4.901 4.901,4.901l9.614,0c2.705,0 4.901,-2.196 4.901,-4.901c0,-2.705 -2.196,-4.901 -4.901,-4.901l-9.614,0Z" style="fill:#fff;"/></g><g id="beam10" serif:id="beam"><path id="beam11" serif:id="beam" d="M44.212,64.534c0,-2.705 -2.196,-4.901 -4.901,-4.901c-2.704,-0 -4.9,2.196 -4.9,4.901l-0,9.614c-0,2.705 2.196,4.901 4.9,4.901c2.705,-0 4.901,-2.196 4.901,-4.901l0,-9.614Z" style="fill:#fff;"/></g><g id="beam12" serif:id="beam"><path id="beam13" serif:id="beam" d="M18.929,11.142c-1.912,-1.912 -5.018,-1.912 -6.931,0c-1.912,1.913 -1.912,5.019 0,6.931l6.799,6.799c1.912,1.912 5.018,1.912 6.931,-0c1.912,-1.913 1.912,-5.019 -0,-6.931l-6.799,-6.799Z" style="fill:#fff;"/></g><g id="beam14" serif:id="beam"><path id="beam15" serif:id="beam" d="M64.108,34.623c-2.705,0 -4.901,2.196 -4.901,4.901c-0,2.705 2.196,4.901 4.901,4.901l9.614,0c2.705,0 4.901,-2.196 4.901,-4.901c-0,-2.705 -2.196,-4.901 -4.901,-4.901l-9.614,0Z" style="fill:#fff;"/></g></g></g></svg>
    </template>

    <template v-if="mode == 'dark'">
        <svg width="100%" height="100%" viewBox="0 0 79 80" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" xml:space="preserve" style="fill-rule:evenodd;clip-rule:evenodd;stroke-linejoin:round;stroke-miterlimit:2;"><g id="mode_dark"><rect id="Bounds" x="0" y="-0" width="78.623" height="79.049" style="fill:none;"/><circle cx="39.311" cy="39.524" r="15.734" style="fill:#fff;"/><g id="beams"><g id="beam"><path id="beam1" serif:id="beam" d="M44.212,14.515c0,-2.705 -2.196,-4.901 -4.901,-4.901c-2.704,0 -4.901,2.196 -4.901,4.901c0,2.705 2.197,4.901 4.901,4.901c2.705,0 4.901,-2.196 4.901,-4.901Z" style="fill:#fff;"/></g><g id="beam2" serif:id="beam"><path id="beam3" serif:id="beam" d="M60.662,24.892c1.902,-1.902 1.902,-4.99 0,-6.892l-0.04,-0.039c-1.901,-1.902 -4.989,-1.902 -6.891,-0c-1.901,1.901 -1.901,4.989 0,6.891l0.04,0.04c1.902,1.901 4.989,1.901 6.891,-0Z" style="fill:#fff;"/></g><g id="beam4" serif:id="beam"><path id="beam5" serif:id="beam" d="M25.732,61.103c1.91,-1.91 1.91,-5.011 0,-6.921l-0.009,-0.01c-1.91,-1.91 -5.012,-1.91 -6.921,-0c-1.91,1.91 -1.91,5.011 -0,6.921l0.01,0.01c1.909,1.91 5.011,1.91 6.92,-0Z" style="fill:#fff;"/></g><g id="beam6" serif:id="beam"><path id="beam7" serif:id="beam" d="M60.672,54.167c-1.907,-1.907 -5.004,-1.907 -6.911,0l-0.02,0.02c-1.907,1.907 -1.907,5.004 0,6.911c1.907,1.907 5.004,1.907 6.911,-0l0.02,-0.02c1.907,-1.907 1.907,-5.004 0,-6.911Z" style="fill:#fff;"/></g><g id="beam8" serif:id="beam"><path id="beam9" serif:id="beam" d="M14.52,34.623c-2.702,0 -4.896,2.194 -4.896,4.896l0,0.01c0,2.702 2.194,4.896 4.896,4.896c2.702,0 4.896,-2.194 4.896,-4.896l-0,-0.01c-0,-2.702 -2.194,-4.896 -4.896,-4.896Z" style="fill:#fff;"/></g><g id="beam10" serif:id="beam"><path id="beam11" serif:id="beam" d="M44.212,64.534c0,-2.705 -2.196,-4.901 -4.901,-4.901c-2.704,-0 -4.901,2.196 -4.901,4.901c0,2.704 2.197,4.9 4.901,4.9c2.705,0 4.901,-2.196 4.901,-4.9Z" style="fill:#fff;"/></g><g id="beam12" serif:id="beam"><path id="beam13" serif:id="beam" d="M25.73,17.943c-1.911,-1.911 -5.015,-1.911 -6.926,0l-0.005,0.005c-1.911,1.911 -1.911,5.015 0,6.926c1.911,1.911 5.015,1.911 6.926,0l0.005,-0.005c1.911,-1.911 1.911,-5.014 -0,-6.926Z" style="fill:#fff;"/></g><g id="beam14" serif:id="beam"><path id="beam15" serif:id="beam" d="M64.098,34.623c-2.699,0 -4.891,2.192 -4.891,4.892l-0,0.019c-0,2.699 2.192,4.891 4.891,4.891c2.7,0 4.892,-2.192 4.892,-4.891l0,-0.019c0,-2.7 -2.192,-4.892 -4.892,-4.892Z" style="fill:#fff;"/></g></g></g></svg>
    </template>

    <template v-if="mode == 'darkest'">
        <svg width="100%" height="100%" viewBox="0 0 79 80" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" xml:space="preserve" style="fill-rule:evenodd;clip-rule:evenodd;stroke-linejoin:round;stroke-miterlimit:2;"><g id="mode_darkest"><rect id="Bounds" x="0" y="-0" width="78.623" height="79.049" style="fill:none;"/><path d="M39.315,23.791c8.684,-0 15.734,7.05 15.734,15.733c0,8.684 -7.05,15.734 -15.734,15.734c-8.683,0 -15.733,-7.05 -15.733,-15.734c-0,-8.683 7.05,-15.733 15.733,-15.733Zm0,4.737c6.069,0 10.997,4.927 10.997,10.996c-0,6.069 -4.928,10.996 -10.997,10.996c-6.068,0 -10.996,-4.927 -10.996,-10.996c0,-6.069 4.928,-10.996 10.996,-10.996Z" style="fill:#fff;"/><g id="beams"><g id="beam"><path id="beam1" serif:id="beam" d="M44.216,14.515c0,-2.705 -2.196,-4.901 -4.901,-4.901c-2.704,0 -4.9,2.196 -4.9,4.901c-0,2.705 2.196,4.901 4.9,4.901c2.705,0 4.901,-2.196 4.901,-4.901Z" style="fill:#fff;"/></g><g id="beam2" serif:id="beam"><path id="beam3" serif:id="beam" d="M60.666,24.892c1.902,-1.902 1.902,-4.99 0,-6.892l-0.04,-0.039c-1.901,-1.902 -4.989,-1.902 -6.891,-0c-1.901,1.901 -1.901,4.989 0,6.891l0.04,0.04c1.902,1.901 4.99,1.901 6.891,-0Z" style="fill:#fff;"/></g><g id="beam4" serif:id="beam"><path id="beam5" serif:id="beam" d="M25.737,61.103c1.909,-1.91 1.909,-5.011 -0,-6.921l-0.01,-0.01c-1.91,-1.91 -5.011,-1.91 -6.921,-0c-1.91,1.91 -1.91,5.011 -0,6.921l0.01,0.01c1.91,1.91 5.011,1.91 6.921,-0Z" style="fill:#fff;"/></g><g id="beam6" serif:id="beam"><path id="beam7" serif:id="beam" d="M60.676,54.167c-1.907,-1.907 -5.004,-1.907 -6.911,0l-0.02,0.02c-1.907,1.907 -1.907,5.004 0,6.911c1.907,1.907 5.004,1.907 6.911,-0l0.02,-0.02c1.907,-1.907 1.907,-5.004 0,-6.911Z" style="fill:#fff;"/></g><g id="beam8" serif:id="beam"><path id="beam9" serif:id="beam" d="M14.524,34.623c-2.702,0 -4.896,2.194 -4.896,4.896l0,0.01c0,2.702 2.194,4.896 4.896,4.896c2.702,0 4.896,-2.194 4.896,-4.896l0,-0.01c0,-2.702 -2.194,-4.896 -4.896,-4.896Z" style="fill:#fff;"/></g><g id="beam10" serif:id="beam"><path id="beam11" serif:id="beam" d="M44.216,64.534c0,-2.705 -2.196,-4.901 -4.901,-4.901c-2.704,-0 -4.9,2.196 -4.9,4.901c-0,2.704 2.196,4.9 4.9,4.9c2.705,0 4.901,-2.196 4.901,-4.9Z" style="fill:#fff;"/></g><g id="beam12" serif:id="beam"><path id="beam13" serif:id="beam" d="M25.734,17.943c-1.911,-1.911 -5.015,-1.911 -6.926,0l-0.005,0.005c-1.911,1.911 -1.911,5.015 0,6.926c1.911,1.911 5.015,1.911 6.926,0l0.005,-0.005c1.911,-1.911 1.911,-5.014 0,-6.926Z" style="fill:#fff;"/></g><g id="beam14" serif:id="beam"><path id="beam15" serif:id="beam" d="M64.103,34.623c-2.7,0 -4.892,2.192 -4.892,4.892l-0,0.019c-0,2.699 2.192,4.891 4.892,4.891c2.699,0 4.891,-2.192 4.891,-4.891l0,-0.019c0,-2.7 -2.192,-4.892 -4.891,-4.892Z" style="fill:#fff;"/></g></g></g></svg>
    </template>
</a>

<script>
(function() {
    const LOCAL_STORAGE_KEY = 'piccoloThemeMode'

    var initialMode = localStorage.getItem(LOCAL_STORAGE_KEY)

    if (initialMode) {
        // Make sure the value in local storage is valid
        if (['light', 'dark', 'darkest'].indexOf(initialMode) == -1) {
            initialMode = 'light'
            localStorage.setItem(LOCAL_STORAGE_KEY, initialMode)
        }
    } else {
        // Check if the client prefers dark mode
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            initialMode = 'dark'
        } else {
            initialMode = 'light'
        }
        localStorage.setItem(LOCAL_STORAGE_KEY, initialMode)
    }

    document.documentElement.dataset.mode = initialMode

    PetiteVue.createApp({
        'mode': initialMode,
        handleClick() {
            let currentMode = this.mode

            if (currentMode == 'light') {
                this.mode = 'dark'
            } else if (currentMode == 'dark') {
                this.mode = 'darkest'
            } else if (currentMode == 'darkest') {
                this.mode = 'light'
            }

            document.documentElement.dataset.mode = this.mode
            localStorage.setItem(LOCAL_STORAGE_KEY, this.mode)

            console.log(this.mode)
        }
    }).mount('#mode_toggle')
})()
</script>
            <p class="mobile_search_link">
                <a href="../search.html" title="Search">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 65 64" fill-rule="evenodd" stroke-linejoin="round" stroke-miterlimit="2">
                        <path d="M14.873 40.009c-2.315-3.943-3.642-8.532-3.642-13.429C11.231 11.91 23.141 0 37.811 0s26.58 11.91 26.58 26.58-11.91 26.58-26.58 26.58a26.44 26.44 0 0 1-14.277-4.161L9.739 62.794a3.12 3.12 0 0 1-4.413 0L.913 58.382c-1.217-1.218-1.217-3.196 0-4.413l13.96-13.96zM37.811 8.054c10.225 0 18.526 8.301 18.526 18.526s-8.301 18.526-18.526 18.526-18.526-8.301-18.526-18.526S27.586 8.054 37.811 8.054z" fill="#fff" />
                    </svg>
                </a>
            </p>
        

        <div class="searchbox_wrapper">
            
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
    </nav>
</div>

    
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<ul>
<li class="toctree-l1"><a class="reference internal" href="../index.html">Intro</a></li>
<li class="toctree-l1"><a class="reference internal" href="../intro/faq.html">FAQ</a></li>
<li class="toctree-l1"><a class="reference internal" href="../whatsnew.html">What’s New</a></li>
<li class="toctree-l1"><a class="reference internal" href="../intro/conceptual-overview.html">Conceptual Overview</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">TLA+</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../core/index.html">Core</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Topics</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="tips.html">General Tips</a></li>
<li class="toctree-l2"><a class="reference internal" href="toolbox.html">Using the Toolbox</a></li>
<li class="toctree-l2"><a class="reference internal" href="cli.html">Beyond the Toolbox</a></li>
<li class="toctree-l2"><a class="reference internal" href="aux-vars.html">Auxiliary Variables</a></li>
<li class="toctree-l2"><a class="reference internal" href="refinement.html">Refinement</a></li>
<li class="toctree-l2"><a class="reference internal" href="unbound-models.html">Handling Unbound Models</a></li>
<li class="toctree-l2"><a class="reference internal" href="optimization.html">Optimizing Model Checking</a></li>
<li class="toctree-l2"><a class="reference internal" href="message-queues.html">Message Queues</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Finite State Machines</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Examples</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../examples/index.html">Operators</a></li>
<li class="toctree-l1"><a class="reference internal" href="../examples/index.html#pluscal-specs">PlusCal Specs</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../reference/glossary.html">Glossary</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference/standard-library.html">Standard Modules</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference/other-resources.html">Other Resources</a></li>
</ul>

<ul>
  <li class="toctree-l1"><a href= "../genindex.html">Index</a></li>
</ul>
        </div>
      </div>



    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <section id="finite-state-machines">
<span id="topic-state-machines"></span><h1>Finite State Machines<a class="headerlink" href="#finite-state-machines" title="Permalink to this headline">¶</a></h1>
<p>The dirty secret of formal methods is that the only way we know to scale it up is to use state machines. So we might as well learn how to write state machines in TLA+!</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>I want to write a formal introduction, but in the meantime, <a class="reference external" href="http://howtomakeanrpg.com/a/state-machines.html">here’s</a> a good introduction to state machines.</p>
</div>
<section id="a-simple-state-machine">
<h2>A Simple State Machine<a class="headerlink" href="#a-simple-state-machine" title="Permalink to this headline">¶</a></h2>
<p>I have a lamp in my bedroom that’s controlled by both a lamp switch and an wall switch. Both switches have to be on in order for the lamp to be one. The state machine looks like this:</p>
<div class="graphviz"><img src="../_images/graphviz-96c8129e2cb41be69b01a4ef4115d00eef0a4434.png" alt="digraph StateMachine {
  {rank=same; WallOff; LampOff}
  {rank=max; On}
  {rank=source; BothOff}
  {BothOff On} -&gt; WallOff[label=&quot;lamp switch&quot;];
  {BothOff On} -&gt; LampOff[label=&quot;wall switch&quot;];
  WallOff -&gt; BothOff[label=&quot;lamp switch&quot;];
  WallOff -&gt; On[label=&quot;wall switch&quot;];
  LampOff -&gt; On[label=&quot;lamp switch&quot;];
  LampOff -&gt; BothOff[label=&quot;wall switch&quot;];
}" class="graphviz" /></div>
<p>A few things to notice:</p>
<ul class="simple">
<li><p>The transitions are nondeterministic. From <span class="math notranslate nohighlight">\(BothOff\)</span>, I can either flip the wall switch or the lamp switch.</p></li>
<li><p>There’s no transitions between <span class="math notranslate nohighlight">\(BothOff\)</span> and <span class="math notranslate nohighlight">\(On\)</span>, I have to flip the switches one at a time.</p></li>
<li><p>For the same reason, there’s no way to get between <span class="math notranslate nohighlight">\(WallOff\)</span> and <span class="math notranslate nohighlight">\(LampOff\)</span>.</p></li>
</ul>
<p>In PlusCal, we can model a state machine by placing <a class="reference internal" href="../core/concurrency.html#await"><span class="std std-ref">await</span></a> statements inside an <a class="reference internal" href="../core/nondeterminism.html#either"><span class="std std-ref">either-or</span></a> block. If the <code class="docutils literal notranslate"><span class="pre">await</span></code> is false the branch is blocked off, but the other branches are still available, preserving nondeterminism.</p>
<div class="literal-block-wrapper docutils container" id="id1">
<div class="highlight-tla notranslate"><div class="highlight"><pre><span></span><span class="c c-PreProc">----</span> <span class="c c-PreProc">MODULE</span> <span class="c c-PreProc">state_machine</span> <span class="c c-PreProc">----</span>

<span class="nf">(*--algorithm lamp</span>
<span class="n">variable</span> <span class="n">state</span> <span class="o">=</span> <span class="s">&quot;BothOff&quot;</span><span class="p">;</span>
<span class="nt">process</span> <span class="n">StateMachine</span> <span class="o">=</span> <span class="s">&quot;SM&quot;</span>
<span class="nf">begin</span>
<span class="nt">  Action:</span>
    <span class="k">either</span> <span class="c">\* this is the state machine</span>
        <span class="ld">await</span> <span class="n">state</span> <span class="o">=</span> <span class="s">&quot;BothOff&quot;</span><span class="p">;</span>
        <span class="n">state</span> <span class="o">:=</span> <span class="s">&quot;WallOff&quot;</span><span class="p">;</span>
      <span class="k">or</span>
        <span class="ld">await</span> <span class="n">state</span> <span class="o">=</span> <span class="s">&quot;BothOff&quot;</span><span class="p">;</span>
        <span class="n">state</span> <span class="o">:=</span> <span class="s">&quot;LampOff&quot;</span><span class="p">;</span>
    <span class="k">or</span>
        <span class="ld">await</span> <span class="n">state</span> <span class="o">=</span> <span class="s">&quot;LampOff&quot;</span><span class="p">;</span>
        <span class="n">state</span> <span class="o">:=</span> <span class="s">&quot;BothOff&quot;</span><span class="p">;</span>
      <span class="k">or</span>
        <span class="ld">await</span> <span class="n">state</span> <span class="o">=</span> <span class="s">&quot;LampOff&quot;</span><span class="p">;</span>
        <span class="n">state</span> <span class="o">:=</span> <span class="s">&quot;On&quot;</span><span class="p">;</span>
    <span class="k">or</span>
        <span class="ld">await</span> <span class="n">state</span> <span class="o">=</span> <span class="s">&quot;WallOff&quot;</span><span class="p">;</span>
        <span class="n">state</span> <span class="o">:=</span> <span class="s">&quot;BothOff&quot;</span><span class="p">;</span>
      <span class="k">or</span>
        <span class="ld">await</span> <span class="n">state</span> <span class="o">=</span> <span class="s">&quot;WallOff&quot;</span><span class="p">;</span>
        <span class="n">state</span> <span class="o">:=</span> <span class="s">&quot;On&quot;</span><span class="p">;</span>
    <span class="k">or</span>
        <span class="ld">await</span> <span class="n">state</span> <span class="o">=</span> <span class="s">&quot;On&quot;</span><span class="p">;</span>
        <span class="n">state</span> <span class="o">:=</span> <span class="s">&quot;LampOff&quot;</span><span class="p">;</span>
      <span class="k">or</span>
        <span class="ld">await</span> <span class="n">state</span> <span class="o">=</span> <span class="s">&quot;On&quot;</span><span class="p">;</span>
        <span class="n">state</span> <span class="o">:=</span> <span class="s">&quot;WallOff&quot;</span><span class="p">;</span>
    <span class="k">end</span> <span class="k">either</span><span class="p">;</span>
    <span class="k">goto</span> <span class="n">Action</span><span class="p">;</span>
<span class="nf">end process</span><span class="p">;</span>
<span class="nf">end algorithm; *)</span>
<span class="c c-PreProc">====</span>
</pre></div>
</div>
<div class="code-block-caption"><span class="caption-text"><span>9 states / 4 distinct</span> <a class="reference download internal" download="" href="../_downloads/b1662746bb5f20886fa26495a1fb3ecb/state_machine.tla"><code class="xref download docutils literal notranslate"><span class="pre">spec</span></code></a></span><a class="headerlink" href="#id1" title="Permalink to this code">¶</a></div>
</div>
<p>Now that’s a bit long, as we need one transition per state machine. We could simplify this with a macro:</p>
<div class="highlight-tla notranslate"><div class="highlight"><pre><span></span><span class="nf">macro</span> <span class="n">transition</span><span class="p">(</span><span class="n">from</span><span class="p">,</span> <span class="n">to</span><span class="p">)</span> <span class="nf">begin</span>
  <span class="ld">await</span> <span class="n">state</span> <span class="o">=</span> <span class="n">from</span><span class="p">;</span>
  <span class="n">state</span> <span class="o">:=</span> <span class="n">to</span><span class="p">;</span>
<span class="nf">end macro</span><span class="p">;</span>
</pre></div>
</div>
<p>Or even</p>
<div class="highlight-tla notranslate"><div class="highlight"><pre><span></span><span class="nf">macro</span> <span class="n">transition</span><span class="p">(</span><span class="n">from</span><span class="p">,</span> <span class="n">set_to</span><span class="p">)</span> <span class="nf">begin</span>
  <span class="ld">await</span> <span class="n">state</span> <span class="o">=</span> <span class="n">from</span><span class="p">;</span>
  <span class="k">with</span> <span class="n">to</span> <span class="s">\in</span> <span class="n">set_to</span> <span class="nf">begin</span>
    <span class="n">state</span> <span class="o">:=</span> <span class="n">to</span><span class="p">;</span>
  <span class="k">end</span> <span class="k">with</span><span class="p">;</span>
<span class="nf">end macro</span><span class="p">;</span>
</pre></div>
</div>
<p>In my opinion, things look a little cleaner if we just do it all in TLA+.</p>
<div class="literal-block-wrapper docutils container" id="id2">
<div class="highlight-tla notranslate"><div class="highlight"><pre><span></span><span class="c c-PreProc">----</span> <span class="c c-PreProc">MODULE</span> <span class="c c-PreProc">state_machine</span> <span class="c c-PreProc">----</span>
<span class="kn">VARIABLE</span> <span class="n">state</span>

<span class="n">Trans</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span> <span class="o">==</span>
  <span class="o">/\</span> <span class="n">state</span> <span class="o">=</span> <span class="n">a</span>
  <span class="o">/\</span> <span class="n">state&#39;</span> <span class="o">=</span> <span class="n">b</span>

<span class="n">Init</span> <span class="o">==</span> <span class="n">state</span> <span class="o">=</span> <span class="s">&quot;BothOff&quot;</span>

<span class="n">Next</span> <span class="o">==</span> 
  <span class="o">\/</span> <span class="n">Trans</span><span class="p">(</span><span class="s">&quot;BothOff&quot;</span><span class="p">,</span> <span class="s">&quot;WallOff&quot;</span><span class="p">)</span>
  <span class="o">\/</span> <span class="n">Trans</span><span class="p">(</span><span class="s">&quot;BothOff&quot;</span><span class="p">,</span> <span class="s">&quot;LampOff&quot;</span><span class="p">)</span>
  <span class="o">\/</span> <span class="n">Trans</span><span class="p">(</span><span class="s">&quot;WallOff&quot;</span><span class="p">,</span> <span class="s">&quot;On&quot;</span><span class="p">)</span>
  <span class="o">\/</span> <span class="n">Trans</span><span class="p">(</span><span class="s">&quot;WallOff&quot;</span><span class="p">,</span> <span class="s">&quot;BothOff&quot;</span><span class="p">)</span>
  <span class="o">\/</span> <span class="n">Trans</span><span class="p">(</span><span class="s">&quot;LampOff&quot;</span><span class="p">,</span> <span class="s">&quot;BothOff&quot;</span><span class="p">)</span>
  <span class="o">\/</span> <span class="n">Trans</span><span class="p">(</span><span class="s">&quot;LampOff&quot;</span><span class="p">,</span> <span class="s">&quot;On&quot;</span><span class="p">)</span>
  <span class="o">\/</span> <span class="n">Trans</span><span class="p">(</span><span class="s">&quot;On&quot;</span><span class="p">,</span> <span class="s">&quot;WallOff&quot;</span><span class="p">)</span>
  <span class="o">\/</span> <span class="n">Trans</span><span class="p">(</span><span class="s">&quot;On&quot;</span><span class="p">,</span> <span class="s">&quot;LampOff&quot;</span><span class="p">)</span>
  <span class="o">\/</span> <span class="n">Trans</span><span class="p">(</span><span class="s">&quot;error&quot;</span><span class="p">,</span> <span class="s">&quot;fetching&quot;</span><span class="p">)</span>

<span class="n">Spec</span> <span class="o">==</span> <span class="n">Init</span> <span class="o">/\</span> <span class="ni">[]</span><span class="p">[</span><span class="n">Next</span><span class="p">]</span><span class="n">_state</span>
<span class="c c-PreProc">====</span>
</pre></div>
</div>
<div class="code-block-caption"><span class="caption-text"><span>9 states / 4 distinct</span> <a class="reference download internal" download="" href="../_downloads/988aa49cd26b3b724a3841650ba6138e/state_machine.tla"><code class="xref download docutils literal notranslate"><span class="pre">spec</span></code></a></span><a class="headerlink" href="#id2" title="Permalink to this code">¶</a></div>
</div>
<p>For this reason I’m going to stick with TLA+ going forward. You can still do state machines in PlusCal, it’s just that more complicated stuff is messier.</p>
</section>
<section id="hierarchical-state-machines">
<h2>Hierarchical State Machines<a class="headerlink" href="#hierarchical-state-machines" title="Permalink to this headline">¶</a></h2>
<p>What’s better than a state machine? A <em>nested</em> state machine.</p>
<p>Also known as <a class="reference external" href="https://www.cs.scranton.edu/~mccloske/courses/se507/harel_Statecharts.pdf">Harel Statecharts</a>, hierarchical state machines allow states inside of other states. If state P’ is inside of state P, then P’ can take any transitions that P can take. A simple example is the UI of a web app. You can log on or off, and when logged in you start in a homepage and can move to any secondary page. To make things interesting we’ll say one of the secondary pages also as subpages.</p>
<div class="graphviz"><img src="../_images/graphviz-3aede7855e73c210040b9259daf89848d1be8451.png" alt="digraph hsl {
compound=true;

LogOut

  LogOut -&gt; Main;
subgraph cluster_app {
  label=&quot;Logged In&quot;;
  Main -&gt; Settings [dir=both];
  Main -&gt; Report1[ltail=&quot;cluster_app&quot;];
  Report1 -&gt; {Main Settings}[ltail=&quot;cluster_reports&quot;];

  subgraph cluster_reports {
    label=Reports
    Report1;
    Report2;
    Report1 -&gt; Report2[dir=both];
  }
}
Main -&gt; LogOut[ltail=&quot;cluster_app&quot;];
}" class="graphviz" /></div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>There’s a few different flavors of HSM. For this one, I’m following three restrictions:</p>
<ol class="arabic simple">
<li><p>Transitions can start from any state, but must end in a “leaf” state. You can’t be in <code class="docutils literal notranslate"><span class="pre">LoggedIn</span></code> or <code class="docutils literal notranslate"><span class="pre">Reports</span></code>, you have to be in <code class="docutils literal notranslate"><span class="pre">Main</span></code> or <code class="docutils literal notranslate"><span class="pre">Report1</span></code>.</p></li>
<li><p>A state can’t have two different parent states.</p></li>
<li><p>No state cycles.</p></li>
</ol>
</div>
<p>To model the hierarchical states, I want to be able to write <code class="docutils literal notranslate"><span class="pre">Trans(&quot;LoggedIn&quot;,</span> <span class="pre">&quot;Logout&quot;)</span></code> and have that include every state of the app: Main, Settings, Report1, and Report2. So we need an <code class="docutils literal notranslate"><span class="pre">In(state1,</span> <span class="pre">state2)</span></code> that’s recursive. Then <code class="docutils literal notranslate"><span class="pre">Trans</span></code> becomes</p>
<div class="highlight-tla notranslate"><div class="highlight"><pre><span></span><span class="n">Trans</span><span class="p">(</span><span class="n">from</span><span class="p">,</span> <span class="n">to</span><span class="p">)</span> <span class="o">==</span>
  <span class="o">/\</span> <span class="n">In</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">from</span><span class="p">)</span> <span class="c">\* Recursive!</span>
  <span class="o">/\</span> <span class="n">state&#39;</span> <span class="o">=</span> <span class="n">to</span>
</pre></div>
</div>
<p>To represent the state hierarchy, we can go either top-down (a function from states to the set of child states) or bottom-up (a function from states to their parent states). Each has relative tradeoffs:</p>
<ol class="arabic simple">
<li><p><em>Top-down</em>: Function domain guaranteed to be all states. Can accidentally give two states the same child.</p></li>
<li><p><em>Bottom-up</em>: Impossible for a state to have two parents. Worse ergonomics on checking <code class="docutils literal notranslate"><span class="pre">In</span></code>, as not all states will be in the function’s domain. Harder to check if a state doesn’t have children.</p></li>
</ol>
<p>Ah heck, let’s implement both and check they’re equivalent.</p>
<div class="literal-block-wrapper docutils container" id="id3">
<div class="highlight-tla notranslate"><div class="highlight"><pre><span></span><span class="c c-PreProc">----</span> <span class="c c-PreProc">MODULE</span> <span class="c c-PreProc">reports</span> <span class="c c-PreProc">----</span>
<span class="kn">EXTENDS</span> <span class="n">TLC</span> <span class="c">\* For @@</span>
<span class="kn">VARIABLE</span> <span class="n">state</span>

<span class="n">States</span> <span class="o">==</span> <span class="n">{</span>
  <span class="s">&quot;LogOut&quot;</span><span class="p">,</span> 
  <span class="s">&quot;LogIn&quot;</span><span class="p">,</span> <span class="s">&quot;Main&quot;</span><span class="p">,</span> <span class="s">&quot;Settings&quot;</span><span class="p">,</span> 
    <span class="s">&quot;Reports&quot;</span><span class="p">,</span> <span class="s">&quot;Report1&quot;</span><span class="p">,</span> <span class="s">&quot;Report2&quot;</span>
<span class="n">}</span>

<span class="n">TopDown</span> <span class="o">==</span> <span class="p">[</span><span class="n">LogIn</span> <span class="o">|-&gt;</span> <span class="n">{</span><span class="s">&quot;Main&quot;</span><span class="p">,</span> <span class="s">&quot;Settings&quot;</span><span class="p">,</span> <span class="s">&quot;Reports&quot;</span><span class="n">}</span><span class="p">,</span> 
              <span class="n">Reports</span> <span class="o">|-&gt;</span> <span class="n">{</span><span class="s">&quot;Report1&quot;</span><span class="p">,</span> <span class="s">&quot;Report2&quot;</span><span class="n">}</span><span class="p">]</span> <span class="o">@@</span> <span class="p">[</span><span class="n">s</span> <span class="s">\in</span> <span class="n">States</span> <span class="o">|-&gt;</span> <span class="n">{}</span><span class="p">]</span>
              <span class="c">\* @@ is function left-merge        ^^</span>

<span class="n">BottomUp</span> <span class="o">==</span> <span class="p">[</span><span class="n">Report1</span> <span class="o">|-&gt;</span> <span class="s">&quot;Reports&quot;</span><span class="p">,</span> <span class="n">Report2</span> <span class="o">|-&gt;</span> <span class="s">&quot;Reports&quot;</span><span class="p">,</span>
           <span class="n">Reports</span> <span class="o">|-&gt;</span> <span class="s">&quot;LogIn&quot;</span><span class="p">,</span> <span class="n">Main</span> <span class="o">|-&gt;</span> <span class="s">&quot;LogIn&quot;</span><span class="p">,</span> <span class="n">Settings</span> <span class="o">|-&gt;</span> <span class="s">&quot;LogIn&quot;</span><span class="p">]</span>

<span class="c">\* For TopDown we need to make sure that there are no double-parents</span>
<span class="kn">ASSUME</span> <span class="s">\A</span> <span class="n">s1</span><span class="p">,</span> <span class="n">s2</span> <span class="s">\in</span> <span class="n">States</span><span class="p">:</span> <span class="n">s1</span> <span class="o">#</span> <span class="n">s2</span> <span class="o">=&gt;</span> <span class="n">TopDown</span><span class="p">[</span><span class="n">s1</span><span class="p">]</span> <span class="nb">\cap</span> <span class="n">TopDown</span><span class="p">[</span><span class="n">s2</span><span class="p">]</span> <span class="o">=</span> <span class="n">{}</span>

<span class="n">RECURSIVE</span> <span class="n">InTD</span><span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span>
<span class="n">InTD</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span> <span class="o">==</span>
  <span class="o">\/</span> <span class="n">s</span> <span class="o">=</span> <span class="n">p</span>
  <span class="o">\/</span> <span class="s">\E</span> <span class="n">c</span> <span class="s">\in</span> <span class="n">TopDown</span><span class="p">[</span><span class="n">p</span><span class="p">]:</span>
    <span class="n">InTD</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>

<span class="n">RECURSIVE</span> <span class="n">InBU</span><span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span>
<span class="n">InBU</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span> <span class="o">==</span>
  <span class="o">\/</span> <span class="n">s</span> <span class="o">=</span> <span class="n">p</span>
  <span class="o">\/</span> <span class="s">\E</span> <span class="n">c</span> <span class="s">\in</span> <span class="n">DOMAIN</span> <span class="n">BottomUp</span><span class="p">:</span>
      <span class="o">/\</span> <span class="n">p</span> <span class="o">=</span> <span class="n">BottomUp</span><span class="p">[</span><span class="n">c</span><span class="p">]</span>
      <span class="o">/\</span> <span class="n">InBU</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>

<span class="c">\* Check the two are identical</span>
<span class="kn">ASSUME</span> <span class="s">\A</span> <span class="n">s</span><span class="p">,</span> <span class="n">s2</span> <span class="s">\in</span> <span class="n">States</span><span class="p">:</span> <span class="n">InTD</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">s2</span><span class="p">)</span> <span class="o">&lt;=&gt;</span> <span class="n">InBU</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">s2</span><span class="p">)</span>

<span class="n">Trans</span><span class="p">(</span><span class="n">from</span><span class="p">,</span> <span class="n">to</span><span class="p">)</span> <span class="o">==</span>
  <span class="o">/\</span> <span class="n">InTD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">from</span><span class="p">)</span>
  <span class="o">/\</span> <span class="n">state&#39;</span> <span class="o">=</span> <span class="n">to</span>

<span class="n">Init</span> <span class="o">==</span> <span class="n">state</span> <span class="o">=</span> <span class="s">&quot;LogOut&quot;</span>

<span class="n">Next</span> <span class="o">==</span>
  <span class="o">\/</span> <span class="n">Trans</span><span class="p">(</span><span class="s">&quot;LogOut&quot;</span><span class="p">,</span> <span class="s">&quot;Main&quot;</span><span class="p">)</span>
  <span class="o">\/</span> <span class="n">Trans</span><span class="p">(</span><span class="s">&quot;Main&quot;</span><span class="p">,</span> <span class="s">&quot;Settings&quot;</span><span class="p">)</span>
  <span class="o">\/</span> <span class="n">Trans</span><span class="p">(</span><span class="s">&quot;Settings&quot;</span><span class="p">,</span> <span class="s">&quot;Main&quot;</span><span class="p">)</span>
  <span class="o">\/</span> <span class="n">Trans</span><span class="p">(</span><span class="s">&quot;LogIn&quot;</span><span class="p">,</span> <span class="s">&quot;LogOut&quot;</span><span class="p">)</span>
  <span class="o">\/</span> <span class="n">Trans</span><span class="p">(</span><span class="s">&quot;LogIn&quot;</span><span class="p">,</span> <span class="s">&quot;Report1&quot;</span><span class="p">)</span>
  <span class="o">\/</span> <span class="n">Trans</span><span class="p">(</span><span class="s">&quot;Report1&quot;</span><span class="p">,</span> <span class="s">&quot;Report2&quot;</span><span class="p">)</span>
  <span class="o">\/</span> <span class="n">Trans</span><span class="p">(</span><span class="s">&quot;Report2&quot;</span><span class="p">,</span> <span class="s">&quot;Report1&quot;</span><span class="p">)</span>
  <span class="o">\/</span> <span class="n">Trans</span><span class="p">(</span><span class="s">&quot;Reports&quot;</span><span class="p">,</span> <span class="s">&quot;Main&quot;</span><span class="p">)</span>

<span class="n">Spec</span> <span class="o">==</span> <span class="n">Init</span> <span class="o">/\</span> <span class="ni">[]</span><span class="p">[</span><span class="n">Next</span><span class="p">]</span><span class="n">_state</span>
<span class="n">AlwaysInLeaf</span> <span class="o">==</span> <span class="n">TopDown</span><span class="p">[</span><span class="n">state</span><span class="p">]</span> <span class="o">=</span> <span class="n">{}</span>
<span class="c c-PreProc">====</span>
</pre></div>
</div>
<div class="code-block-caption"><span class="caption-text"><span>16 states / 5 distinct</span> <a class="reference download internal" download="" href="../_downloads/20a603d24acbaee70cd23e8e460295ed/reports.tla"><code class="xref download docutils literal notranslate"><span class="pre">spec</span></code></a></span><a class="headerlink" href="#id3" title="Permalink to this code">¶</a></div>
</div>
</section>
</section>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
    
        <div id="show_right_sidebar">
            <p><a class="toggle_right_sidebar" href="#"><span class="icon">&lt;</span><span>Page contents</span></a></p>
        </div>

        <div id="right_sidebar">
            <p><a class="toggle_right_sidebar" href="#"><span class="icon">&gt;</span><span>Page contents:</span></a></p>
            <div class="page_toc">
                <ul>
<li><a class="reference internal" href="#">Finite State Machines</a><ul>
<li><a class="reference internal" href="#a-simple-state-machine">A Simple State Machine</a></li>
<li><a class="reference internal" href="#hierarchical-state-machines">Hierarchical State Machines</a></li>
</ul>
</li>
</ul>

            </div>
        </div>
    

      <div class="clearer"></div>
    </div>
    <div class="button_nav_wrapper">
        <div class="button_nav">
            <div class="left">
                
                <a href="message-queues.html">
                    <span class="icon">&lt;</span><span>Modelling Message Queues</span></a>
                
            </div>

            <div class="right">
                
                    <a href="../examples/index.html"><span>Operators</span><span class="icon">&gt;</span></a>
                
            </div>
        </div>
    </div>


    <div class="footer" role="contentinfo">
        &#169; Copyright 2022, Hillel Wayne.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 4.4.0.
    </div>

<p id="theme_credit">Styled using the <a href="https://github.com/piccolo-orm/piccolo_theme">Piccolo Theme</a></p>
  </body>
</html>